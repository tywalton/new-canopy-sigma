name: Deploy Org Site

on:
  workflow_run:
    workflows: ["Tests"]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: org-site
  cancel-in-progress: true

jobs:
  deploy:
    if: >-
      ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main') }}
    runs-on: ubuntu-latest
    env:
      CANOPY_BASE_PATH: /app
      CANOPY_BASE_URL: https://canopy-iiif.github.io/app
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org

      - name: Install dependencies
        run: |
          npm config set fund false
          npm config set audit false
          npm ci --no-audit --no-fund || npm install --no-audit --no-fund

      - name: Build documentation site for canopy-iiif.github.io/app
        env:
          CANOPY_CHUNK_SIZE: "10"
          CANOPY_FETCH_CONCURRENCY: "1"
        run: npm run build

      - name: Verify site output
        run: npx tsx app/scripts/canopy-build.mts --verify

      - name: Inspect site directory
        run: |
          du -sh site || true
          ls -lah site || true

      - name: Build org site commit message
        id: org_commit
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "text=Sync canopy-iiif.github.io from ${SHORT_SHA}" >> "$GITHUB_OUTPUT"

      - name: Stage org site files
        env:
          ORG_SITE_OUT_DIR: .org-build
        run: node packages/helpers/org/prepare-org-site.js

      - name: Push to canopy-iiif.github.io (main)
        env:
          ORG_SITE_OUT_DIR: .org-build
          ORG_SITE_PUSH_TOKEN: ${{ secrets.ORG_SITE_PUSH_TOKEN }}
          ORG_SITE_TARGET_REPO: canopy-iiif/canopy-iiif.github.io
          ORG_SITE_TARGET_BRANCH: main
          ORG_SITE_COMMIT_MESSAGE: ${{ steps.org_commit.outputs.text }}
        run: node packages/helpers/org/push-org-site.js
